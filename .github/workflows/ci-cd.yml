name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  AWS_REGION: ap-southeast-2
  ECR_REGISTRY: 697697503013.dkr.ecr.ap-southeast-2.amazonaws.com

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.2"

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint
        continue-on-error: true

      - name: Type Check
        run: bun run check-types
        continue-on-error: true

      - name: Build
        run: bun run build

  deploy:
    name: Deploy to EC2
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push carmen-app
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/carmen-app/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/carmen-app:latest
            ${{ env.ECR_REGISTRY }}/carmen-app:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_BACKEND_URL=${{ secrets.NEXT_PUBLIC_BACKEND_URL }}
            NEXT_PUBLIC_EXCHANGE_RATE_API_KEY=${{ secrets.NEXT_PUBLIC_EXCHANGE_RATE_API_KEY }}
            NEXT_PUBLIC_WS_URL=${{ secrets.NEXT_PUBLIC_WS_URL }}
            NEXT_PUBLIC_X_APP_ID=${{ secrets.NEXT_PUBLIC_X_APP_ID }}
            NEXT_PUBLIC_SENTRY_DSN=${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
            NEXT_PUBLIC_FRONTEND_URL=${{ secrets.NEXT_PUBLIC_FRONTEND_URL }}
          cache-from: type=gha,scope=carmen-app
          cache-to: type=gha,mode=max,scope=carmen-app

      - name: Build & push carmen-platform
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/carmen-platform/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/carmen-platform:latest
            ${{ env.ECR_REGISTRY }}/carmen-platform:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_BACKEND_URL=${{ secrets.NEXT_PUBLIC_BACKEND_URL }}
            NEXT_PUBLIC_EXCHANGE_RATE_API_KEY=${{ secrets.NEXT_PUBLIC_EXCHANGE_RATE_API_KEY }}
            NEXT_PUBLIC_X_APP_ID=${{ secrets.NEXT_PUBLIC_X_APP_ID }}
          cache-from: type=gha,scope=carmen-platform
          cache-to: type=gha,mode=max,scope=carmen-platform

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.INSTANCE_HOST }}
          username: ${{ secrets.INSTANCE_USER }}
          key: ${{ secrets.INSTANCE_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e

            ECR_REGISTRY="${{ env.ECR_REGISTRY }}"
            AWS_REGION="${{ env.AWS_REGION }}"

            # Setup 4GB swap if not already present
            if [ ! -f /swapfile ]; then
              echo "Setting up 4GB swap..."
              sudo fallocate -l 4G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
            elif ! swapon --show | grep -q /swapfile; then
              sudo swapon /swapfile
            fi

            # Login to ECR
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

            # Pull latest images
            docker pull $ECR_REGISTRY/carmen-app:latest
            docker pull $ECR_REGISTRY/carmen-platform:latest

            # Stop and restart containers using docker compose
            export AWS_ECR_REGISTRY=$ECR_REGISTRY
            export DOCKER_IMAGE_PREFIX=carmen

            mkdir -p ~/carmen-turborepo-frontend
            cd ~/carmen-turborepo-frontend

            # Ensure docker-compose.prod.yml is up to date
            cat > ~/carmen-turborepo-frontend/docker-compose.prod.yml << 'COMPOSE_EOF'
            services:
              carmen-app:
                image: ${AWS_ECR_REGISTRY}/${DOCKER_IMAGE_PREFIX}-app:latest
                container_name: carmen-app
                restart: unless-stopped
                ports:
                  - "3000:3000"
                env_file:
                  - ~/.env.carmen-app

              carmen-platform:
                image: ${AWS_ECR_REGISTRY}/${DOCKER_IMAGE_PREFIX}-platform:latest
                container_name: carmen-platform
                restart: unless-stopped
                ports:
                  - "3001:3001"
                env_file:
                  - ~/.env.carmen-platform
            COMPOSE_EOF

            docker compose -f ~/carmen-turborepo-frontend/docker-compose.prod.yml up -d --force-recreate

            # Cleanup old images
            docker image prune -f
